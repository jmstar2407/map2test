// Función de cómo llegar desde el modal
function comoLlegarDesdeModal() {
    // Obtener latitud y longitud de la propiedad actualmente mostrada en el modal
    const propertyId = parseInt(window.location.hash.substring('#id-'.length));
    const property = [...alquileres, ...ventas].find(p => p.id === propertyId);

    if (property) {
        const lat = property.latLng ? property.latLng[0] : property.lat;
        const lng = property.latLng ? property.latLng[1] : property.lng;

        // Verificar si estamos en un dispositivo iOS o Android
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

        if (isIOS) {
            // Crear enlaces personalizados para cada aplicación en iOS
            const appleMapsUrl = `maps://?q=${lat},${lng}`;
            const googleMapsUrl = `comgooglemaps://?q=${lat},${lng}&center=${lat},${lng}`;
            const wazeUrl = `waze://?ll=${lat},${lng}&navigate=yes`;
            const uberUrl = `uber://?action=setPickup&dropoff[latitude]=${lat}&dropoff[longitude]=${lng}`;

            // Función auxiliar para abrir URLs y mostrar mensaje de error si la app no está instalada
            function openAppWithFallback(url, fallbackMessage) {
                let timeout;
                const start = Date.now();
                
                // Intentar abrir la aplicación
                window.location.href = url;

                // Verificar después de un pequeño delay si la app no se abrió
                timeout = setTimeout(() => {
                    const elapsed = Date.now() - start;
                    if (elapsed < 1500) {
                        alert(fallbackMessage);  // Mostrar mensaje personalizado
                    }
                }, 1000); // Se puede ajustar este valor dependiendo del tiempo de respuesta
            }

            // Mostrar el modal
            const modal = document.getElementById('modal-map-ios');
            modal.style.display = 'block';

            // Obtener los botones y asociar las URLs con función de fallback
            document.getElementById('appleMapsBtn').onclick = function() {
                openAppWithFallback(appleMapsUrl, "Apple Maps no está instalado.");
            };
            document.getElementById('googleMapsBtn').onclick = function() {
                openAppWithFallback(googleMapsUrl, "Google Maps no está instalado.");
            };
            document.getElementById('wazeBtn').onclick = function() {
                openAppWithFallback(wazeUrl, "Waze no está instalado.");
            };
            document.getElementById('uberBtn').onclick = function() {
                openAppWithFallback(uberUrl, "Uber no está instalado.");
            };

            // Cerrar el modal cuando se hace clic en la "X"
            document.querySelector('.close-modal-map-ios').onclick = function() {
                modal.style.display = 'none';
            };

            // Cerrar el modal si el usuario hace clic fuera del contenido del modal
            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            };
        } else {
            // Para Android, usar geo URI scheme
            const url = `geo:${lat},${lng}?q=${lat},${lng}`;
            window.location.href = url;
        }
    } else {
        console.error("No se pudo encontrar la propiedad para obtener las coordenadas.");
    }
}
