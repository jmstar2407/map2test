<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArríbaTe</title>
    <link rel="shortcut icon" href="./img/logo4.png">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="./css/stylesup.css" />
    <link rel="stylesheet" href="./css/stylesmodal.css" />

    <style>
        .carousel {
            position: relative;
            width: 100%;
            overflow: hidden;
            text-align: center;
            height: 190px;
            /* pointer-events: none;  Eliminamos esto para permitir la interacción táctil */
        }

        .carousel-inner {
            display: flex;
            /* Mostramos las imágenes en una línea horizontal */
            transition: transform 0.3s ease-in-out;
            /* Agregamos una transición suave */
            width: 100%;
        }

        .carousel img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            /* display: none;  Ya no ocultamos las imágenes */
            max-width: 100%;
            /*max-height: 190px;*/
            /*border-radius: 14px 14px 0px 0px;*/
        }

        .carousel img.active {
            /* display: block;  Ya no necesitamos esta clase */
        }

        .carousel .indicators {
            /*top: -214px;*/
        }

        /* Estilos para botones de navegación */
        .carousel .prev,
        .carousel .next {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
            border-radius: 50%;
            z-index: 10;
        }

        .carousel .prev {
            left: 10px;
        }

        .carousel .next {
            right: 10px;
        }

        /* Estilos para indicadores */
        .carousel .indicators {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 5px;
        }

        .carousel .indicator {
            width: 10px;
            height: 10px;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            cursor: pointer;
        }

        .carousel .indicator.active {
            background-color: white;
        }
    </style>
</head>

<body>
    <!-- MAPA -->
    <div class="mapbox" style="position: fixed;top: 0px;left: 0px;">
        <div id="map" style="background: #aad3df;height: 100%;width: 100%;"></div>

        <button id="fullscreenButton" class="vibrar-button"></button>

        <!-- Botones capas, location -->
        <button id="changeLayerButton" class="layer-button vibrar-button">
            <img src="./img/capasatelite2.png" alt="Cambiar capa" id="layerIcon">
        </button>

        <button id="locateButton" class="vibrar-button"></button>

        <!-- Boton centrar en RD -->
        <button id="centerButton" class="center-button vibrar-button" style="display: none;">
        </button>
        <!-- Boton centrar en RD FIN -->
        <!-- Botones capas, location FIN -->

    </div>
    <!-- MAPA Fin-->

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <script>
        // Inicialización del mapa con un maxZoom aumentado
        var map;

        if (window.innerWidth <= 700) { // ajuste responsive
            map = L.map('map').setView([18.7357, -70.1627], 7);
        } else {
            map = L.map('map').setView([18.7357, -70.1627], 8);
        }

        // Capas de mapa
        var baseMaps = {
            "Claro": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(map),
            "Vista Satelital": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
                maxZoom: 19
            })
        };

        // Definir el ícono personalizado
        const customIcon = L.icon({
            iconUrl: './img/icons/location5.png', // Reemplaza con la ruta de tu imagen personalizada
            iconSize: [38, 38], // Tamaño del ícono [ancho, alto]
            iconAnchor: [19, 19], // Punto de anclaje en el centro del ícono
            className: 'custom-icon',
        });

        // Variables para almacenar el marcador y el círculo
        let userMarker;
        let userCircle;
        let tooltip;

        // Botón de mi ubicación
        const locateButton = document.getElementById('locateButton');

        // Función para formatear números con comas como separadores de miles
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        // Variables de iconos
        var houseIcon = './img/casa4.png';
        var buildingIcon = './img/apartamento2.png';
        var landIcon = './img/solar2.png';

        // Función para obtener el color del fondo del span según el tipo de propiedad
        function getBackgroundColor(iconUrl) {
            if (iconUrl === houseIcon) {
                return '#e17477'; // Color para casas
            } else if (iconUrl === buildingIcon) {
                return '#52bae8'; // Color para apartamentos
            } else if (iconUrl === landIcon) {
                return '#59a739'; // Color para solares
            } else {
                return 'white'; // Color por defecto
            }
        }

        // Creación de íconos personalizados con precio y color según el tipo de propiedad
        function createIcon(iconUrl, price, isAlquiler) {
            var backgroundColor = getBackgroundColor(iconUrl); // Obtener color de fondo
            // Si es un alquiler, añade "/mes" al final del precio
            var priceText = `RD$${formatNumber(price)}` + (isAlquiler ? "/mes" : "");

            return L.divIcon({
                html: `<div style="position: relative; display: flex; flex-direction: column; align-items: center;">
            <img src="${iconUrl}" style="margin-top: -26px;
            width: 32px; height: 32px; background: #0f1931; border-radius: 31px; border-style: solid; border-color: ${backgroundColor}; border-width: 3px;" />
            <span style="background: ${backgroundColor}; 
            font-family: system-ui;color: white;font-size: 12px;font-weight: bold;
            padding: 2px 4px; border-radius: 3px; margin-top: -8px;">${priceText}</span>
            <div class="price-tip" style="border-top-color: ${backgroundColor};"></div>
        </div>`,
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
            });
        }

        // Íconos para referencia
        var roomIcon = './img/icons/habitacion1.svg'; // ícono para habitaciones
        var bathroomIcon = './img/icons/baño1.svg'; // ícono para baños
        var parkingIcon = './img/icons/parqueo1.svg'; // ícono para parqueo
        var areaIcon = './img/icons/area1.svg'; // ícono para área

        // Normalización de ubicaciones
        function normalizeLocation(location) {
            return location.latLng ? { ...location, lat: location.latLng[0], lng: location.latLng[1] } : location;
        }

        // Definición de ubicaciones con información adicional
        var alquileres = [
            {
                id: 334501, latLng: [18.47434844864751, -69.81027832640669], title: 'Los frailes Casa', price: 25000, icon: houseIcon, rooms: 4, bathrooms: 3, parking: 6, area: 329, imageFolder: './properties/alquiler/334501/img/', imageCount: 10,
                caracteristicas: ''
            }
        ];

        var ventas = [];

        // Carousel

        // Función para crear el carrusel
        function createCarousel(imageFolder, imageCount) {
            let carousel = `<div class="carousel">
                                <div class="carousel-inner">
                                <div class="botonmaximizar"></div>`;

            const maxImagesToShow = Math.min(imageCount, 7);

            for (let i = 1; i <= maxImagesToShow; i++) {
                const imgSrc = `${imageFolder}${i}.jpg`;
                carousel += `<img src="${imgSrc}" class="${i === 1 ? 'active' : ''}" alt="Imagen ${i}">`;
            }
            carousel += `
                                </div>
                                <button class="prev">&#10094;</button>
                                <button class="next">&#10095;</button>
                                <div class="indicators">
                                  ${Array.from({ length: maxImagesToShow }, (_, index) => `<span class="indicator ${index === 0 ? 'active' : ''}" data-index="${index}"></span>`).join('')}
                                </div>
                              </div>`;
            return carousel;
        }

        // Función para cambiar la imagen
        function changeImage(carousel, direction) {
            const carouselInner = carousel.querySelector('.carousel-inner');
            const images = carousel.querySelectorAll('.carousel-inner img');
            const indicators = carousel.querySelectorAll('.indicator');
            let currentIndex = Array.from(images).findIndex(img => img.classList.contains('active'));

            // Calcular el nuevo índice
            let newIndex = currentIndex + direction;
            if (newIndex < 0) {
                newIndex = images.length - 1;
            } else if (newIndex >= images.length) {
                newIndex = 0;
            }

            // Actualizar clases 'active'
            images[currentIndex].classList.remove('active');
            indicators[currentIndex].classList.remove('active');
            images[newIndex].classList.add('active');
            indicators[newIndex].classList.add('active');

            // Mover el carousel-inner
            const imageWidth = images[0].offsetWidth;
            const newPosition = -newIndex * imageWidth;
            carouselInner.style.transform = `translateX(${newPosition}px)`;
        }

        // Función para establecer la imagen activa al hacer clic en un indicador
        function setActiveImage(carousel, index) {
            const carouselInner = carousel.querySelector('.carousel-inner');
            const images = carousel.querySelectorAll('.carousel-inner img');
            const indicators = carousel.querySelectorAll('.indicator');
            const currentIndex = Array.from(images).findIndex(img => img.classList.contains('active'));

            if (currentIndex === index) return; // Si ya está activo, no hacer nada

            // Actualizar clases 'active'
            images[currentIndex].classList.remove('active');
            indicators[currentIndex].classList.remove('active');
            images[index].classList.add('active');
            indicators[index].classList.add('active');

            // Mover el carousel-inner
            const imageWidth = images[0].offsetWidth;
            const newPosition = -index * imageWidth;
            carouselInner.style.transform = `translateX(${newPosition}px)`;
        }

        // Funciones para manejar el evento touch
        function addTouchEvents(carousel) {
            let touchStartX = 0;
            let touchEndX = 0;
            const threshold = 50; // Umbral de deslizamiento en píxeles

            carousel.addEventListener('touchstart', function (event) {
                touchStartX = event.changedTouches[0].clientX;
            }, false);

            carousel.addEventListener('touchend', function (event) {
                touchEndX = event.changedTouches[0].clientX;
                handleGesture();
            }, false);

            function handleGesture() {
                const deltaX = touchEndX - touchStartX;
                if (Math.abs(deltaX) > threshold) {
                    if (deltaX > 0) {
                        // Deslizamiento hacia la derecha -> Imagen anterior
                        changeImage(carousel, -1);
                    } else {
                        // Deslizamiento hacia la izquierda -> Siguiente imagen
                        changeImage(carousel, 1);
                    }
                }
            }
        }

        // Añadimos los event listeners a cada carrusel después de crearlo
        function initializeCarouselEvents() {
            const carousels = document.querySelectorAll('.carousel');
            carousels.forEach(carousel => {
                const prevButton = carousel.querySelector('.prev');
                const nextButton = carousel.querySelector('.next');
                const indicators = carousel.querySelectorAll('.indicator');

                prevButton.addEventListener('click', () => changeImage(carousel, -1));
                nextButton.addEventListener('click', () => changeImage(carousel, 1));

                indicators.forEach(indicator => {
                    indicator.addEventListener('click', () => {
                        const index = parseInt(indicator.getAttribute('data-index'));
                        setActiveImage(carousel, index);
                    });
                });

                // Añadir eventos táctiles
                addTouchEvents(carousel);
            });
        }

        // Crear marcadores y popups con carruseles
        function createMarkers(locations, markersArray) {
            locations.forEach(function (location) {
                location = normalizeLocation(location);
                var isAlquiler = markersArray === alquilerMarkers;  // Verifica si es alquiler
                var marker = L.marker([location.lat, location.lng], { icon: createIcon(location.icon, location.price, isAlquiler) });

                // Crear el carrusel si hay una carpeta de imágenes disponible
                var carousel = location.imageFolder ? createCarousel(location.imageFolder, location.imageCount) : '';

                // Agregar condicionalmente "/mes" al precio si es un alquiler
                var priceText = `RD$ ${formatNumber(location.price)}`;
                if (markersArray === alquilerMarkers) {
                    priceText += '/mes';
                }

                marker.bindPopup(
                    `<button id="vermodal" onclick="openModal(${JSON.stringify(location).replace(/"/g, '&quot;')})"></button>
                ${carousel}
                <div class="informacion-basica"> 

                 <button id="btncomollegar" onclick="comoLlegar(${location.lat}, ${location.lng})"><img src="./img/icons/location1.svg">Cómo llegar</button>
                <span class="price-text">${priceText}</span><br>
                <b>${location.title}</b><br>

                <div class="detalles-basicos"> 
                <img src="${roomIcon}" style="width: 26px; height: 26px;"/> ${location.rooms}
                <img src="${bathroomIcon}" style="width: 26px; height: 26px; margin-left: 10px;"/> ${location.bathrooms}
                <img src="${parkingIcon}" style="width: 26px; height: 26px; margin-left: 10px;"/> ${location.parking}
                <img src="${areaIcon}" style="width: 26px; height: 26px; margin-left: 10px;"/> ${location.area} m²
                </div>
                </div>`
                ).addTo(map).on('popupopen', function () {
                    // Inicializar eventos del carrusel en el popup
                    initializeCarouselEvents();
                });

                markersArray.push(marker);
            });
        }

        var alquilerMarkers = [];
        var ventaMarkers = [];

        createMarkers(alquileres, alquilerMarkers);
        createMarkers(ventas, ventaMarkers);

        // Variable para mantener el tipo activo
        var activeType = 'alquiler';

        // Funciones para mostrar/ocultar marcadores
        function toggleMarkers(type) {
            activeType = type; // Actualizar el tipo activo

            var showMarkers = type === 'alquiler' ? alquilerMarkers : ventaMarkers;
            var hideMarkers = type === 'alquiler' ? ventaMarkers : alquilerMarkers;

            showMarkers.forEach(marker => marker.addTo(map));
            hideMarkers.forEach(marker => map.removeLayer(marker));

            filterMarkers(); // Filtrar los marcadores después de cambiar el tipo
        }

        // Botones alquiler-venta con su .active
        const buttonGroups = {
            alquiler: ['alquilerButton', 'alquilerButton-filter', 'alquilerButton-rpsv'],
            venta: ['ventaButton', 'ventaButton-filter', 'ventaButton-rpsv']
        };

        function activateGroup(group) {
            for (const buttonId in buttonGroups) {
                const buttons = buttonGroups[buttonId];
                buttons.forEach(id => {
                    const button = document.getElementById(id);
                    if (buttonId === group) {
                        button.classList.add('active');
                    } else {
                        button.classList.remove('active');
                    }
                });
            }
            toggleMarkers(group);
        }

        // Event listeners para todos los botones
        for (const group in buttonGroups) {
            buttonGroups[group].forEach(id => {
                const button = document.getElementById(id);
                if (button) { // Verificar si el botón existe
                    button.addEventListener('click', () => activateGroup(group));
                }
            });
        }

        // Asegurar que 'alquilerButton-rpsv' esté activo al cargar la página
        activateGroup('alquiler');

        // Botones alquiler-venta con su .active FIN

        // Inicialmente mostrar solo los alquileres
        toggleMarkers('alquiler');
    </script>

    <script src="./js/scriptmodal.js"></script>
</body>

</html>
